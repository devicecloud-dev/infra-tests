name: Test Feature Flags

on:
  # Run at 5 AM UTC daily
  schedule:
    - cron: "0 5 * * *"
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run tests against"
        type: choice
        options:
          - prod
          - dev
        default: "prod"
        required: true
      use-beta:
        description: "Use beta version"
        type: boolean
        default: false
        required: false

jobs:
  test-feature-flags:
    name: Run Feature Flags Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Async Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow.yaml
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Async Test
          async: true

      - name: Run json-file Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow.yaml
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Json File Flag Test
          json-file: true

      - name: Extract and Log Console URL
        run: |
          jq -r '.consoleUrl' *_dcd.json

      - name: Run Android Locale Test
        continue-on-error: true
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow-german.yaml
          device-locale: "de_DE"
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Android Locale Test

      - name: Run iOS Locale Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-binary-id: ${{ github.event.inputs.environment == 'dev' && '9e4f3c0b-146e-4bc8-8820-d49eb5e25198' || '81155b2c-e18d-4527-871a-6788068d836b' }}
          workspace: ./flows/ios-flow-german.yaml
          device-locale: "de_DE"
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run iOS Locale Test

      - name: Run Android Orientation Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow.yaml
          orientation: 90
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Android Orientation Test

      - name: Run Download Artifacts Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow.yaml
          download-artifacts: ALL
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Download Artifacts Test

      - name: Assert Download Artifacts ZIP File
        run: |
          # Check if any download zip files were created
          if ls artifacts.zip 1> /dev/null 2>&1; then
            echo "✅ Download artifacts ZIP file found:"
            ls -la artifacts.zip
          else
            echo "❌ No download artifacts ZIP file found"
            echo "Files in current directory:"
            ls -la
            exit 1
          fi

      - name: Run Android Environment Variables Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/android-flow-env.yaml
          env: |
            BUNDLEID=org.wikipedia
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Android Environment Variables Test

      - name: Run iOS Environment Variables Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-binary-id: ${{ github.event.inputs.environment == 'dev' && '9e4f3c0b-146e-4bc8-8820-d49eb5e25198' || '81155b2c-e18d-4527-871a-6788068d836b' }}
          workspace: ./flows/ios-flow-env.yaml
          env: |
            BUNDLEID=org.wikimedia.wikipedia
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run iOS Environment Variables Test

      - name: Run Android Camera Check Test
        uses: devicecloud-dev/device-cloud-for-maestro@v2
        with:
          api-key: ${{ github.event.inputs.environment == 'dev' && secrets.DCD_DEV_API_KEY || secrets.DCD_API_KEY }}
          api-url: ${{ github.event.inputs.environment == 'dev' && 'https://api.dev.devicecloud.dev' || '' }}
          app-file: ./binaries/sample.apk
          workspace: ./flows/check-cam.yaml
          use-beta: ${{ github.event.inputs.use-beta }}
          name: Run Android Camera Check Test
          retry: 1